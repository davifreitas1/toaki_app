{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mapa em Tempo Real | ToAki</title>
    <style>
        body, html { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
        #map { height: 100%; width: 100%; }
        .status-bar { position: absolute; top: 10px; left: 50%; transform: translateX(-50%); 
                      background: white; padding: 8px 20px; border-radius: 20px; 
                      box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10; font-weight: bold; }
        .btn-logout { position: absolute; top: 10px; right: 10px; z-index: 10; background: red; color: white; padding: 5px 10px; text-decoration: none; border-radius: 5px;}
    </style>
</head>
<body>

    <div id="status" class="status-bar">Conectando...</div>
    <a href="/logout/" class="btn-logout">Sair</a>
    <div id="map"></div>

    <script src="https://maps.googleapis.com/maps/api/js?key={{ google_api_key }}&callback=initApp&loading=async" async defer></script>

    <script>
        // --- CONFIGURA√á√ÉO GLOBAL ---
        const USER_ID = "{{ user_id }}";
        const USER_TYPE = "{{ tipo_usuario }}"; // 'CLIENTE' ou 'VENDEDOR'
        
        let map;
        let myMarker;       // Marcador do pr√≥prio usu√°rio (fantasma)
        let markers = {};   // Armazena marcadores de outros usu√°rios { id: Marker }
        let socket;
        
        // Controle de Sincroniza√ß√£o e Estado
        let syncInterval;   // Loop para limpar fantasmas
        let lastLat = null; // √öltima posi√ß√£o conhecida (para o loop usar)
        let lastLon = null;

        // --- 1. INICIALIZA√á√ÉO (Chamado pelo Google Maps) ---
        function initApp() {
            initMap();
            initWebSocket();
        }

        function initMap() {
            // Come√ßa no centro de SP (ser√° atualizado pelo GPS)
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -23.5505, lng: -46.6333 },
                zoom: 15,
                disableDefaultUI: false, // Permite zoom e controles padr√£o
                mapId: "DEMO_MAP_ID"     // Necess√°rio para recursos modernos (opcional)
            });
            console.log("üó∫Ô∏è Mapa carregado");
        }

        // --- 2. WEBSOCKET (A "Linha Telef√¥nica") ---
        function initWebSocket() {
            const protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
            const wsUrl = protocol + window.location.host + '/ws/mapa/';
            
            socket = new WebSocket(wsUrl);

            socket.onopen = function() {
                updateStatus("üü¢ Online e Monitorando");
                startTrackingGPS(); // S√≥ come√ßa a enviar GPS quando tiver conex√£o

                // --- Sincroniza√ß√£o Autom√°tica (Heartbeat) ---
                // Garante que vendedores distantes (fantasmas) sejam removidos
                clearInterval(syncInterval);
                syncInterval = setInterval(() => {
                   if (lastLat && lastLon) { 
                       // Pede a lista oficial para o servidor a cada 5s
                       sendToSocket("buscarVendedores", {
                           lat: lastLat,
                           lon: lastLon,
                           raioKm: 1
                       });
                   }
                }, 5000); 
            };

            socket.onmessage = function(e) {
                const data = JSON.parse(e.data);
                handleServerMessage(data);
            };

            socket.onclose = function() {
                updateStatus("üî¥ Desconectado. Tentando reconectar...");
                clearInterval(syncInterval); // Para o loop se cair a conex√£o
                setTimeout(initWebSocket, 3000); // Tenta reconectar em 3s
            };
        }

        // --- 3. INPUT: Enviar Dados (GPS -> Backend) ---
        function startTrackingGPS() {
            if (!navigator.geolocation) {
                alert("Seu navegador n√£o suporta Geolocaliza√ß√£o.");
                return;
            }

            // Op√ß√µes para for√ßar Alta Precis√£o (GPS Hardware)
            const geoOptions = {
                enableHighAccuracy: true, 
                timeout: 10000,           
                maximumAge: 0             
            };

            // watchPosition: Dispara sempre que o usu√°rio se move
            navigator.geolocation.watchPosition(
                (position) => {
                    // Atualiza globais para o loop de sync usar
                    lastLat = position.coords.latitude;
                    lastLon = position.coords.longitude;

                    // A) Feedback Instant√¢neo: Move meu pr√≥prio marcador
                    updateMyMarker(lastLat, lastLon);

                    // B) Push: Envia posi√ß√£o para o WebSocket (Signals v√£o disparar)
                    sendToSocket("atualizarLocalizacao", {
                        lat: lastLat,
                        lon: lastLon
                    });
                    
                    // C) Pull: Busca imediata para atualizar o mapa ao andar
                    sendToSocket("buscarVendedores", {
                        lat: lastLat,
                        lon: lastLon,
                        raioKm: 1
                    });
                },
                (error) => console.error("Erro GPS:", error),
                geoOptions
            );
        }

        function sendToSocket(action, payload) {
            if (socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    action: action,
                    payload: payload,
                    requestId: generateUUID() 
                }));
            }
        }

        // --- 4. OUTPUT: Receber Dados (Backend -> Mapa) ---
        function handleServerMessage(data) {
            const action = data.action;
            const payload = data.payload;

            // Debug opcional
            // console.log("üì© Recebido:", action, payload);

            if (action === "vendedorAtualizado" || action === "vendedorMovimentou") {
                // Atualiza√ß√£o unit√°ria via Signal (Push)
                updateOtherMarker(payload);
            } 
            else if (action === "buscarVendedores") {
                // Atualiza√ß√£o em lote via Polling/Request (Pull)
                
                // O Serializer GeoJSON coloca a lista dentro de 'features'
                if (payload.vendedores && payload.vendedores.features) {
                    const listaNova = payload.vendedores.features;

                    // 1. Atualiza/Cria quem est√° na lista
                    listaNova.forEach(v => updateOtherMarker(v));

                    // 2. COLETA DE LIXO (Remove fantasmas) üëª
                    // Cria um Set com os IDs que o servidor diz que existem
                    const idsValidos = new Set(listaNova.map(v => String(v.id)));

                    // Verifica nossos marcadores locais
                    for (const idNoMapa in markers) {
                        if (!idsValidos.has(String(idNoMapa))) {
                            console.log(`üßπ Removendo vendedor fora de alcance: ID ${idNoMapa}`);
                            markers[idNoMapa].setMap(null); // Apaga do mapa
                            delete markers[idNoMapa];       // Apaga da mem√≥ria
                        }
                    }
                }
            }
        }

        // --- 5. MANIPULA√á√ÉO DO MAPA (Visual) ---
        
        function updateMyMarker(lat, lon) {
            const pos = { lat, lng: lon };
            
            // Centraliza o mapa na primeira vez que pega o GPS
            if (!myMarker) {
                map.setCenter(pos);
                myMarker = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: "Voc√™",
                    zIndex: 999, // Garante que voc√™ fique por cima
                    icon: "http://maps.google.com/mapfiles/ms/icons/blue-dot.png" // Azul
                });
            } else {
                myMarker.setPosition(pos);
            }
        }

        function updateOtherMarker(data) {
            // Ignora se o evento for sobre mim mesmo
            if (data.id == USER_ID && USER_TYPE === 'VENDEDOR') return;

            // Extra√ß√£o segura de coordenadas (suporta tanto GeoJSON quanto Payload simples)
            const lat = data.lat || (data.geometry && data.geometry.coordinates[1]);
            const lon = data.lon || (data.geometry && data.geometry.coordinates[0]);
            const id = data.id;
            
            // Tenta pegar o nome de v√°rios lugares poss√≠veis
            const nomeVendedor = data.nome || data.nome_fantasia || (data.properties && data.properties.nome_fantasia) || "Vendedor";
            const estaOnline = (data.esta_online !== undefined) ? data.esta_online : (data.properties && data.properties.esta_online);

            if (!lat || !lon) return;

            // Se o vendedor ficou offline, remove
            if (estaOnline === false) {
                if (markers[id]) {
                    markers[id].setMap(null);
                    delete markers[id];
                }
                return;
            }

            const pos = { lat: lat, lng: lon };

            // Configura√ß√£o do √çcone com Label Flutuante
            const iconConfig = {
                url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png", // Vermelho
                labelOrigin: new google.maps.Point(16, -10) // Ajuste Fino: X=Centro, Y=Acima
            };

            const labelConfig = {
                text: nomeVendedor,
                color: "#c0392b", // Vermelho Escuro
                fontWeight: "bold",
                fontSize: "14px",
            };

            if (markers[id]) {
                // ATUALIZA√á√ÉO SUAVE
                markers[id].setPosition(pos);
                markers[id].setLabel(labelConfig); // Atualiza nome se mudar
            } else {
                // CRIA√á√ÉO
                markers[id] = new google.maps.Marker({
                    position: pos,
                    map: map,
                    title: nomeVendedor,
                    icon: iconConfig,
                    label: labelConfig
                });
            }
        }

        // --- UTILIT√ÅRIOS ---
        function updateStatus(msg) {
            const el = document.getElementById("status");
            if(el) el.innerText = msg;
        }
        
        function generateUUID() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
    </script>
</body>
</html>